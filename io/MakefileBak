CXX=mpic++
CXXFLAGS+=-g -Wall -std=c++11
LIBRARY=-lpthread

INC_DIR=-I./include

TEST_DIR=./Test
TEST_OBJ_DIR=${TEST_DIR}/obj

OBJ_DIR=./obj
SRC_DIR=./src ./src/IOStrategy
BIN_DIR=./bin

TARGET=$(basename ${TARGET_SRCS})
TARGET_SRCS=$(wildcard ${TEST_DIR}/*.cc)
TARGET_OBJS=$(patsubst %.cc, %.o, ${TARGET_SRCS})

SRCS=$(foreach dir, $(SRC_DIR), $(wildcard ${dir}/*.cc))
OBJFILES=$(patsubst %.cc, %.o, $(SRCS))
OBJS=$(patsubst %.cc, $(OBJ_DIR)/%.o, $(notdir $(SRCS)))

all: $(OBJFILES) $(TARGET_OBJS) TestAtomic TestThread TestMPIIO

$(OBJFILES):%.o:%.cc
	@echo "Compiling $^ ==> $@..."
	$(CXX) -c $^ -o $(OBJ_DIR)/$(notdir $@) $(LIBRARY) $(INC_DIR) $(CXXFLAGS) 

$(TARGET_OBJS):%.o:%.cc
	@echo "Compiling $^ ==> $@..."
	$(CXX) -c $^ -o $(TEST_OBJ_DIR)/$(notdir $@) $(LIBRARY) $(INC_DIR) $(CXXFLAGS) 

TestAtomic : $(OBJS)
	@echo "Compiling $^ ==> $@..."
	$(CXX) $(TEST_OBJ_DIR)/TestAtomic.o $^ -o ${BIN_DIR}/$@ $(LIBRARY) $(INC_DIR) $(CXXFLAGS) 

TestThread : $(OBJS)
	@echo "Compiling $^ ==> $@..."
	$(CXX) $(TEST_OBJ_DIR)/TestThread.o $^ -o ${BIN_DIR}/$@ $(LIBRARY) $(INC_DIR) $(CXXFLAGS)

TestMPIIO : $(OBJS)
	@echo "Compiling $^ ==> $@..."
	$(CXX) $(TEST_OBJ_DIR)/TestMPIIO.o $^ -o ${BIN_DIR}/$@ $(LIBRARY) $(INC_DIR) $(CXXFLAGS)

$(OBJ_DIR):
	mkdir -p $(OBJ_DIR)

$(TEST_OBJ_DIR):
	mkdir -p $(TEST_OBJ_DIR)

$(BIN_DIR):
	mkdir -p $(BIN_DIR)
.PHONY : clean
clean :
	-rm $(OBJ_DIR)/* $(BIN_DIR)/* $(TEST_OBJ_DIR)/*

